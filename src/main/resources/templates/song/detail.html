<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head('노래 상세')}"></head>
<body>

<div th:replace="~{fragments/header :: navbar}"></div>

<main class="container">

  <!-- 중복 리뷰 작성 시 alert -->
  <script th:if="${reviewAlreadyExists}" th:inline="javascript">
    alert('이 곡에 대해서는 이미 리뷰를 작성했습니다. 리뷰 수정 기능을 사용하세요.');
  </script>

  <!-- 곡 상세 정보 -->
  <div class="song-detail">

    <!-- 앨범 이미지 & 정보 -->
    <div class="song-detail-header">
      <div class="album-cover" th:if="${song.albumImageUrl != null}">
        <img th:src="${song.albumImageUrl}" alt="앨범 이미지">
      </div>

      <div class="song-detail-info">
        <h1 class="song-detail-title" th:text="${song.title}">곡 제목</h1>

        <div class="song-meta">
          <p class="song-meta-item">
            <span class="meta-label">아티스트</span>
            <a th:text="${song.artist}" th:href="${song.artistDetailUrl}" class="meta-link">Artist</a>
          </p>

          <p class="song-meta-item">
            <span class="meta-label">장르</span>
            <span class="genre-badge" th:text="${song.playlistGenre}">Genre</span>
          </p>

          <p class="song-meta-item">
            <a th:href="@{'https://open.spotify.com/track/' + ${song.spotifyId}}"
               target="_blank" class="spotify-link">
              🎵 Spotify에서 듣기
            </a>
          </p>
        </div>

        <!-- 평균 별점 -->
        <div class="rating-summary">
          <div class="rating-score">
            <span class="score-number" th:text="${#numbers.formatDecimal(ratingSummary.averageScore(), 1, 1)}">0.0</span>
            <span class="score-stars">⭐</span>
          </div>
          <p class="rating-count">
            <span th:text="${ratingSummary.ratingCount()}">0</span>명이 평가했어요
          </p>
        </div>
      </div>
    </div>

    <!-- 내 별점 -->
    <section class="card my-rating-section">
      <h2 class="section-title">내 별점</h2>

      <!-- 비로그인 -->
      <div th:if="${session.LOGIN_USER == null}" class="login-prompt">
        <p>별점을 남기려면 <a th:href="@{/login}" class="link-primary">로그인</a>이 필요합니다.</p>
      </div>

      <!-- 로그인 -->
      <div th:if="${session.LOGIN_USER != null}">
        <form th:action="@{'/songs/' + ${song.id} + '/rating'}"
              method="post"
              class="rating-form">
          <div class="form-group">
            <label class="form-label">점수</label>
            <input type="number"
                   name="score"
                   step="0.5"
                   min="0.5"
                   max="5.0"
                   class="form-input"
                   th:value="${myRating != null} ? ${myRating.score} : 3.0">
          </div>
          <button type="submit" class="btn-primary">
            <span th:text="${myRating != null} ? '수정하기' : '등록하기'">등록하기</span>
          </button>
        </form>

        <form th:if="${myRating != null}"
              th:action="@{'/songs/' + ${song.id} + '/rating/delete'}"
              method="post"
              class="delete-form">
          <button type="submit" class="btn-danger">별점 삭제</button>
        </form>
      </div>
    </section>

    <!-- 오디오 특성 -->
    <section class="card audio-features">
      <h2 class="section-title">오디오 특성</h2>
      <div class="audio-features-list">
        <p class="audio-feature-item" th:text="${audioSummary.energyText}">
          전체적으로 에너지가 낮은, 잔잔한 곡이에요.
        </p>
        <p class="audio-feature-item" th:text="${audioSummary.danceabilityText}">
          리듬을 타기 좋은 편이에요. 가볍게 몸을 흔들기 좋습니다.
        </p>
        <p class="audio-feature-item" th:text="${audioSummary.tempoText}">
          템포가 빠른 편이에요! 신나고 속도감 있는 곡일 가능성이 커요.
        </p>
        <p class="audio-feature-item" th:text="${audioSummary.moodText}">
          밝고 경쾌한 분위기의 곡이에요!
        </p>
      </div>
    </section>

    <!-- 리뷰 -->
    <section class="card reviews-section">
      <h2 class="section-title">리뷰</h2>

      <!-- 비로그인 -->
      <div th:if="${session.LOGIN_USER == null}" class="login-prompt">
        <p>리뷰를 남기려면 <a th:href="@{/login}" class="link-primary">로그인</a>이 필요합니다.</p>
      </div>

      <!-- 로그인 -->
      <div th:if="${session.LOGIN_USER != null}">
        <form th:action="@{'/songs/' + ${song.id} + '/reviews'}"
              method="post"
              class="review-form">
          <textarea name="content" rows="3" class="form-textarea" placeholder="이 곡에 대한 생각을 공유해주세요..."></textarea>
          <button type="submit" class="btn-primary">리뷰 남기기</button>
        </form>
      </div>

      <!-- 리뷰 목록 -->
      <div th:if="${reviews == null or #lists.isEmpty(reviews)}" class="empty-state">
        <p>아직 등록된 리뷰가 없습니다.</p>
      </div>

      <div th:if="${reviews != null and !#lists.isEmpty(reviews)}" class="reviews-list">
        <div th:each="review : ${reviews}" class="review-item">

          <!-- 리뷰 헤더 -->
          <div class="review-header">
            <div class="review-author">
              <a th:href="@{'/users/' + ${review.user.id}}" class="author-name">
                <strong th:text="${review.user.nickname}">닉네임</strong>
              </a>
              <span class="review-date" th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd HH:mm')}">
                2025-01-01 12:00
              </span>
            </div>
          </div>

          <!-- 리뷰 내용 -->
          <p class="review-content" th:text="${review.content}">리뷰 내용</p>

          <!-- 본인 글일 때만 수정/삭제 -->
          <div th:if="${session.LOGIN_USER != null and session.LOGIN_USER.id == review.user.id}"
               class="review-actions">
            <form th:action="@{'/songs/' + ${song.id} + '/reviews/' + ${review.id} + '/edit'}"
                  method="post"
                  class="review-edit-form">
              <textarea name="content" rows="2" class="form-textarea" th:text="${review.content}"></textarea>
              <button type="submit" class="btn-secondary">수정</button>
            </form>

            <form th:action="@{'/songs/' + ${song.id} + '/reviews/' + ${review.id} + '/delete'}"
                  method="post">
              <button type="submit" class="btn-danger-small">삭제</button>
            </form>
          </div>

          <!-- 댓글 영역 -->
          <div class="comments-section" th:with="comments=${commentsByReview[review.id]}">

            <!-- 댓글 작성 폼 -->
            <div th:if="${session.LOGIN_USER != null}">
              <form th:action="@{'/songs/' + ${song.id} + '/reviews/' + ${review.id} + '/comments'}"
                    method="post"
                    class="comment-form">
                <textarea name="content" rows="2" class="form-textarea" placeholder="댓글을 입력하세요..."></textarea>
                <button type="submit" class="btn-secondary">댓글 달기</button>
              </form>
            </div>

            <!-- 댓글 목록 -->
            <div th:if="${comments == null or #lists.isEmpty(comments)}" class="comments-empty">
              <p>아직 댓글이 없습니다.</p>
            </div>

            <div th:if="${comments != null and !#lists.isEmpty(comments)}" class="comments-list">
              <div th:each="comment : ${comments}" class="comment-item">
                <div class="comment-header">
                  <a th:href="@{'/users/' + ${comment.writer.id}}" class="comment-author">
                    <strong th:text="${comment.writer.nickname}">댓글작성자</strong>
                  </a>
                  <span class="comment-date" th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
                </div>

                <p class="comment-content" th:text="${comment.content}">댓글 내용</p>

                <form th:if="${session.LOGIN_USER != null and session.LOGIN_USER.id == comment.writer.id}"
                      th:action="@{'/songs/' + ${song.id} + '/reviews/' + ${review.id} + '/comments/' + ${comment.id} + '/delete'}"
                      method="post">
                  <button type="submit" class="btn-danger-small">댓글 삭제</button>
                </form>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

  </div>

</main>

</body>
</html>
